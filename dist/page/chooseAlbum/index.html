<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta http-equiv="Page-Exit" content="blendTrans(Duration=1)">
    <meta http-equiv="Page-Enter" content="blendTrans(Duration=1)">
    <title>Coach</title>
    <link rel="stylesheet" href="index.css">
</head>
<body style="margin: 0">
<div class="container">
    <img src="../../assets/images/page_bg@2x.jpg" class="bg"/>
    <div class="logo-img"><img src="../../assets/images/logo@2x.png" /></div>
    <div class="photo-box" id="photo-box">
        <img src="../../assets/images/album_1@2x.png" alt="" id="album">
        <div class="photo-bg">
            <img src="../../assets/images/album_1@2x.png" alt="" id="photo-bg">
        </div>
        <div class="upload-photo" id="uploadPhoto"></div>
        <div class="star">
            <img src="../../assets/images/star.png" alt="">
        </div>
    </div>
    <p style="text-align: center">请选择您喜欢的相框</p>
    <div class="bg-list">
        <div class="item" data-idx="1">
            <img src="../../assets/images/album_1@2x.png" alt="">
        </div>
        <div class="item" data-idx="2">
            <img src="../../assets/images/album_2@2x.png" alt="">
        </div>
        <div class="item last" data-idx="3">
            <img src="../../assets/images/album_3@2x.png" alt="">
        </div>
    </div>
    <div class="btn-box">
        <div class="btn prev">上一步</div>
        <div class="btn last next">下一步</div>
    </div>
    <img src="" alt="" id="canvasImg">
</div>
<script src="../../common/zepto/1.2.0/zepto.js"></script>
<script src="../../common/zepto/1.2.0/ajax.js"></script>
<script src="../../common/zepto/1.2.0/event.js"></script>
<script src="../../common/util.js"></script>
<script src="../../common/jweixin-1.4.0.js"></script>
<script src="../../common/common.js"></script>
<script src="../../common/html2canvas.min.js"></script>
<script src="index.js"></script>
<script>
    Zepto(function($){
        // function base64ToBlob (code) {
        //     let parts = code.split(';base64,')
        //     let contentType = parts[0].split(':')[1]
        //     let raw = window.atob(parts[1])
        //     let rawLength = raw.length
        //     let uInt8Array = new Uint8Array(rawLength)
        //     for (let i = 0; i < rawLength; ++i) {
        //         uInt8Array[i] = raw.charCodeAt(i)
        //     }
        //     return new Blob([uInt8Array], {type: contentType})
        // }
        var localIds = window.localStorage.getItem('localIds')
        wx.uploadImage({
            localId: localIds, // 需要上传的图片的本地ID，由chooseImage接口获得
            isShowProgressTips: 1, // 默认为1，显示进度提示
            success: function (respons) {
                // 返回图片的服务器端ID
                util.ajax('GET',`http://coach.realmshow.com/api/webchat-api/file/upload?media_id=${respons.serverId}`,{}).then((res)=>{
                    if (res.data.code === 200) {
                        console.log('res', res)
                        var content = JSON.parse(res.data)
                        $('#uploadPhoto').attr('style','background-image', `url:(${content.url})`)
                    }
                }).catch((err)=>{
                    console.log('err', err)
                })

            }
        })
        $('.bg-list .item').click(function(){
            console.log($(this).attr('data-idx'))
            var idx = $(this).attr('data-idx');
            $('#album').attr('src',`../../assets/images/album_${idx}@2x.png`)
            $('#photo-bg').attr('src',`../../assets/images/album_${idx}@2x.png`)
        })

        $('.btn-box .prev').click(function(){
            window.location.href = '../choosePhoto/index.html'
        })

        $('.btn-box .next').click(function(){
            // setTimeout(()=>{
            console.log('123')
            html2canvas(document.getElementById('photo-box')).then(function(canvas){
                console.log(canvas)
                console.log(canvas.toDataURL())
                console.log('345')
                window.localStorage.setItem('firstImg', canvas.toDataURL())
                window.location.href = '../dealPhoto/index.html'
            })
            console.log('234')
        })
    })
</script>
</body>
</html>
