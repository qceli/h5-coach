<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta http-equiv="Page-Exit" content="blendTrans(Duration=1)">
    <meta http-equiv="Page-Enter" content="blendTrans(Duration=1)">
    <title>Coach</title>
    <link rel="stylesheet" href="index.css">
    <script src="../../common/zepto/1.2.0/zepto.js"></script>
    <script src="../../common/zepto/1.2.0/ajax.js"></script>
    <script src="../../common/zepto/1.2.0/event.js"></script>
    <script src="../../common/util.js"></script>
    <script src="../../common/jweixin-1.4.0.js"></script>
    <script src="../../common/common.js"></script>
    <script src="index.js"></script>
</head>
<body style="margin: 0">
<div class="container">
    <img src="../../assets/images/page_bg@2x.jpg" class="bg"/>
    <div class="logo-img"><img src="../../assets/images/logo@2x.png" /></div>
    <div class="people-img">
        <img src="../../assets/images/album_1@2x.png" alt="分享背景图" class="img">
    </div>
    <div class="note-text">
        <div>您到专属合影已生成</div>
        <div>点击右上角分享至朋友圈</div>
    </div>
</div>
<script>
    Zepto(function($){

        var firstImg = window.localStorage.getItem('firstImg')
        $('.people-img .img').attr('src', firstImg);
        function base64ToBlob (code) {
            let parts = code.split(';base64,')
            let contentType = parts[0].split(':')[1]
            let raw = window.atob(parts[1])
            let rawLength = raw.length
            let uInt8Array = new Uint8Array(rawLength)
            for (let i = 0; i < rawLength; ++i) {
                uInt8Array[i] = raw.charCodeAt(i)
            }
            return new Blob([uInt8Array], { type: contentType })
        }

        function GetQueryString(name) {
            var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
            var r = window.location.search.substr(1).match(reg);
            if(r!=null)return  unescape(r[2]); return null;
        }

        var imgUrl = GetQueryString("url");
        var myHref = window.location.href
        if(imgUrl) {
            wx.onMenuShareTimeline({
                title: 'coach', // 分享时的标题
                link: `${myHref}?url=${imgUrl}`, // 分享时的链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
                imgUrl: link, // 分享时显示的图标
                success: function () {
                    console.log()
                },
                cancel: function () {
                    alert('取消分享')
                }
            })
            wx.onMenuShareAppMessage({
                title: `coach`, // 分享标题
                desc: `coach`, // 分享描述
                link: `${myHref}?url=${imgUrl}`, // 分享链接
                imgUrl: link // 分享图片
            })
        }else {
            util.ajax('POST', 'http://coach.realmshow.com/api/file/upload', {filecontent :base64ToBlob(firstImg)}).then((res)=>{
                var content = JSON.parse(res.data)
                wx.onMenuShareTimeline({
                    title: 'coach', // 分享时的标题
                    link: `${myHref}?url=${content.url}`, // 分享时的链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
                    imgUrl: content.url, // 分享时显示的图标
                    success: function () {
                        console.log()
                    },
                    cancel: function () {
                        alert('取消分享')
                    }
                })
                wx.onMenuShareAppMessage({
                    title: `coach`, // 分享标题
                    desc: `coach`, // 分享描述
                    link: `${myHref}?url=${content.url}`, // 分享链接
                    imgUrl: content.url // 分享图片
                })
            })
        }
    })
</script>
</body>
</html>
